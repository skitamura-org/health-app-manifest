apiVersion: v1
kind: ConfigMap
metadata:
  name: webhook-playbook
data:
  playbook.yaml: |
    - hosts: localhost
      vars_files:
        - /secrets/env.yml
      vars:
        git_org: ${{ values.org_name }}
        git_repo: ${{ values.app_name }}-app
        #git_token: ""
        webhook_url: "webhook-${{ values.app_name }}-el-${{ values.app_name }}-dev" 
        #cluster_url: ""
        #webhook_url: https://webhook-${{ values.app_name }}-el-${{ values.app_name }}-dev.apps.aws-cluster-01.sandbox1966.opentlc.com
        #webhook_secret: ""
      tasks:
        - name: Get current webhook
          uri:
            url: "https://api.github.com/repos/{{ git_org }}/{{ git_repo }}/hooks" 
            method: GET
            return_content: true
            validate_certs: false
            status_code: 200
            headers:
              Authorization: "Bearer {{ git_token }}"
              Accept: application/vnd.github+json
          register: r_github_hooks
      
        - name: Create webhook
          when: r_github_hooks.json | length == 0
          uri:
            url: "https://api.github.com/repos/{{ git_org }}/{{ git_repo }}/hooks" 
            method: POST
            return_content: true
            validate_certs: false
            body_format: json
            status_code: 201
            headers:
              Authorization: "Bearer {{ git_token }}"
              Accept: application/vnd.github+json
            body: >-
              {
                "name": "web",
                "active": true,
                "events": [
                    "push",
                    "tag_push",
                    "releases",
                ],
                "config":{
                    "url": "https://{{ webhook_url }}/{{ cluster_url }}",
                    "secret": "{{ webhook_secret }}",
                    "content_type": "json",
                    "insecure_ssl": "0"
                }
              }
